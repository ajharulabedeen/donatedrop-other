<!DOCTYPE html>
<!-- saved from url=(0089)https://golb.hplar.ch/2018/01/Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><style id="stndz-style"></style>

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sending Web push messages from Spring Boot to Browsers</title>
<link rel="stylesheet" href="./Sending Web push messages from Spring Boot to Browsers_files/blog-3.css">
<link href="https://golb.hplar.ch/feed.rss" rel="alternate" type="application/rss+xml" title="Ralph&#39;s Blog: RSS Feed">
<link href="https://golb.hplar.ch/feed.atom" rel="alternate" type="application/atom+xml" title="Ralph&#39;s Blog: Atom Feed">
<style>._3emE9--dark-theme .-S-tR--ff-downloader{background:rgba(30,30,30,.93);border:1px solid rgba(82,82,82,.54);box-shadow:0 4px 7px rgba(30,30,30,.55);color:#fff}._3emE9--dark-theme .-S-tR--ff-downloader ._6_Mtt--header ._2VdJW--minimize-btn{background:#3d4b52}._3emE9--dark-theme .-S-tR--ff-downloader ._6_Mtt--header ._2VdJW--minimize-btn:hover{background:#131415}._3emE9--dark-theme .-S-tR--ff-downloader ._10vpG--footer{background:rgba(30,30,30,.93)}._2mDEx--white-theme .-S-tR--ff-downloader{background:#fff;border:1px solid rgba(82,82,82,.54);box-shadow:0 4px 7px rgba(30,30,30,.55);color:#314c75}._2mDEx--white-theme .-S-tR--ff-downloader ._6_Mtt--header{font-weight:700}._2mDEx--white-theme .-S-tR--ff-downloader ._2dFLA--container ._2bWNS--notice{border:0;color:rgba(0,0,0,.88)}._2mDEx--white-theme .-S-tR--ff-downloader ._10vpG--footer{background:#fff}.-S-tR--ff-downloader{display:block;overflow:hidden;position:fixed;bottom:20px;right:7.1%;width:330px;height:180px;background:rgba(30,30,30,.93);border-radius:2px;color:#fff;z-index:99999999;border:1px solid rgba(82,82,82,.54);box-shadow:0 4px 7px rgba(30,30,30,.55);transition:.5s}.-S-tR--ff-downloader._3M7UQ--minimize{height:62px}.-S-tR--ff-downloader._3M7UQ--minimize .nxuu4--file-info,.-S-tR--ff-downloader._3M7UQ--minimize ._6_Mtt--header{display:none}.-S-tR--ff-downloader ._6_Mtt--header{padding:10px;font-size:17px;font-family:sans-serif}.-S-tR--ff-downloader ._6_Mtt--header ._2VdJW--minimize-btn{float:right;background:#f1ecec;height:20px;width:20px;text-align:center;padding:2px;margin-top:-10px;cursor:pointer}.-S-tR--ff-downloader ._6_Mtt--header ._2VdJW--minimize-btn:hover{background:#e2dede}.-S-tR--ff-downloader ._13XQ2--error{color:red;padding:10px;font-size:12px;line-height:19px}.-S-tR--ff-downloader ._2dFLA--container{position:relative;height:100%}.-S-tR--ff-downloader ._2dFLA--container .nxuu4--file-info{padding:6px 15px 0;font-family:sans-serif}.-S-tR--ff-downloader ._2dFLA--container .nxuu4--file-info div{margin-bottom:5px;width:100%;overflow:hidden}.-S-tR--ff-downloader ._2dFLA--container ._2bWNS--notice{margin-top:21px;font-size:11px}.-S-tR--ff-downloader ._10vpG--footer{width:100%;bottom:0;position:absolute;font-weight:700}.-S-tR--ff-downloader ._10vpG--footer ._2V73d--loader{-webkit-animation:n0BD1--rotation 3.5s linear forwards;animation:n0BD1--rotation 3.5s linear forwards;position:absolute;top:-120px;left:calc(50% - 35px);border-radius:50%;border:5px solid #fff;border-top-color:#a29bfe;height:70px;width:70px;display:flex;justify-content:center;align-items:center}.-S-tR--ff-downloader ._10vpG--footer ._24wjw--loading-bar{width:100%;height:18px;background:#dfe6e9;border-radius:5px}.-S-tR--ff-downloader ._10vpG--footer ._24wjw--loading-bar ._1FVu9--progress-bar{height:100%;background:#8bc34a;border-radius:5px}.-S-tR--ff-downloader ._10vpG--footer ._2KztS--status{margin-top:10px}.-S-tR--ff-downloader ._10vpG--footer ._2KztS--status ._1XilH--state{float:left;font-size:.9em;letter-spacing:1pt;text-transform:uppercase;width:100px;height:20px;position:relative}.-S-tR--ff-downloader ._10vpG--footer ._2KztS--status ._1jiaj--percentage{float:right}</style></head>
<body>

  <header>
    <a href="https://golb.hplar.ch/index.html">Home</a> | <a href="https://golb.hplar.ch/feedback/2018-01-Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html">Send Feedback</a>
    <h1>Sending Web push messages from Spring Boot to Browsers</h1>
    <p>Published: January 09, 2018&nbsp;&nbsp;•&nbsp;&nbsp;Updated: December 07, 2018&nbsp;&nbsp;•&nbsp;&nbsp;<a href="https://golb.hplar.ch/index.html?tag=java">java</a>, <a href="https://golb.hplar.ch/index.html?tag=javascript">javascript</a>, <a href="https://golb.hplar.ch/index.html?tag=pwa">pwa</a>, <a href="https://golb.hplar.ch/index.html?tag=spring">spring</a></p>
  </header>
 	
  <article class="markdown-body">
  <p>Service Workers not only can intercept requests from the browser and cache assets. They also bring another tool to the Web platform: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Push_API" target="_blank">Push Messages</a>.</p> 
<p>In this blog post, we're going to create a simple Spring Boot application that periodically sends push messages over Firebase Cloud Messaging (FCM) to subscribed clients. The client is a trivial JavaScript application that displays the messages. As example payload, we use the jokes from the <a href="http://www.icndb.com/" target="_blank">Internet Chuck Norris Database</a></p> 
<p>The setup is very similar to my previous blog about <a href="https://golb.hplar.ch/2017/02/Send-messages-from-Spring-Boot-to-Ionic-2-over-FCM.html" target="_blank">Push Messages in a Cordova App</a>. The difference is that this example works in any browser with a Service Worker implementation and does not depend on any native plugins.</p> 
<h2><a href="https://golb.hplar.ch/2018/01/Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html#firebase" id="firebase">Firebase</a></h2> 
<p>Before we start coding, we need to set up a Firebase project. Login to your Firebase Console <a href="https://console.firebase.google.com/">https://console.firebase.google.com</a> and create a new project or use an existing one.</p> 
<div> 
 <img alt="step1" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push1.png"> 
 <img alt="step2" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push2.png"> 
</div> 
<p>On the home page, click on the "Add Web App" icon.<br> <img alt="step3" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push3.png"></p> 
<p>Give the web app an arbitrary name and click on "Register app".<br> <img alt="step4" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push4.png"></p> 
<p>From the next screen we need the <code>firebaseConfig</code> object. Copy the information to the clipboard or save it into a temporary text file.<br> <img alt="step5" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push5.png"></p> 
<br> 
<p>Click on the cogwheel icon and click "Project settings" and then open the Cloud Messaging tab.</p> 
<div> 
 <img alt="step6" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push6.png"> 
 <img alt="step7" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push7.png"> 
</div>
<p>Scroll down to "Web Push certificates" and click "Generate key pair".<br> <img alt="step8" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push8.png"></p> 
<p>Copy the key pair and save it in a temporary location. We need this key later when we write the JavaScript code.<br> <img alt="step9" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push9.png"></p> 
<p>Next we need to create a Service Account for the Java code. Select the tab "Service accounts".<br> <img alt="step10" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push10.png"></p> 
<p>Click on "Generate new private key".<br> <img alt="step11" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push11.png"></p> 
<p>Download the service account file with "Generate key".<br> <img alt="step12" src="./Sending Web push messages from Spring Boot to Browsers_files/web_push12.png"></p> 
<p>Keep this file safe, and don't commit it into a public repository. Everybody with access to this file has full access to the Firebase project.</p> 
<h2><a href="https://golb.hplar.ch/2018/01/Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html#server" id="server">Server</a></h2> 
<p>The server is a Spring Boot application built with the <a href="https://start.spring.io/">https://start.spring.io</a> page. As a sole dependency, I added "Reactive Web" to the project.</p> 
<p>The server needs to know the location of the Service Account file. To externalize this setting, I created a new application setting and added it to <code>application.properties</code></p> 
<pre><code class="language-properties"><span class="token attr-name">fcm.service-account-file</span><span class="token punctuation">=</span><span class="token attr-value">C:/work/ws/blog/sw-push/demopush-7dacf-firebase-adminsdk-f038n-7c47ad4d8e.json</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/application.properties" target="_blank">application.properties</a></small></p> 
<p>To read this setting, I created a POJO annotated with <code>@ConfigurationProperties</code> and <code>@Component</code>.</p> 
<pre><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">ch<span class="token punctuation">.</span>rasc<span class="token punctuation">.</span>swpush</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties</span><span class="token punctuation">.</span><span class="token class-name">ConfigurationProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"fcm"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FcmSettings</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> serviceAccountFile<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getServiceAccountFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serviceAccountFile<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setServiceAccountFile</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceAccountFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>serviceAccountFile <span class="token operator">=</span> serviceAccountFile<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/java/ch/rasc/swpush/FcmSettings.java" target="_blank">FcmSettings.java</a></small></p> 
<br> 
<p>The PushChuckJokeService bean is responsible for fetching a joke from the Internet Chuck Norris Database and sending push messages over FCM to the subscribed clients.</p> 
<pre><code class="language-java">  <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>fixedDelay <span class="token operator">=</span> <span class="token number">30_000</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendChuckQuotes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">IcndbJoke</span> joke <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>webClient<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">"http://api.icndb.com/jokes/random"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token class-name">IcndbJoke</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">sendPushMessage</span><span class="token punctuation">(</span>joke<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Application</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"send chuck joke"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/java/ch/rasc/swpush/PushChuckJokeService.java#L27-L37" target="_blank">PushChuckJokeService.java</a></small></p> 
<br> To send push messages, we use the official Firebase Admin SDK for Java 
<pre><code class="language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.google.firebase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>firebase-admin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>6.12.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/pom.xml#L32-L35" target="_blank">pom.xml</a></small></p> 
<p>The SDK is also available for Node.js, Go, and Python.</p> 
<br> 
<p>Before we can use the SDK, we need to set it up. For that we need to call the <code>FirebaseApp.initializeApp()</code> method with an options objects. For our example, we only need to specify the path to the Service Account file we downloaded earlier from the Firebase console.</p> 
<pre><code class="language-java">  <span class="token keyword">public</span> <span class="token class-name">FcmClient</span><span class="token punctuation">(</span><span class="token class-name">FcmSettings</span> settings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Path</span> p <span class="token operator">=</span> <span class="token class-name">Paths</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span><span class="token function">getServiceAccountFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> serviceAccount <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newInputStream</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">FirebaseOptions</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FirebaseOptions</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">setCredentials</span><span class="token punctuation">(</span><span class="token class-name">GoogleCredentials</span><span class="token punctuation">.</span><span class="token function">fromStream</span><span class="token punctuation">(</span>serviceAccount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token class-name">FirebaseApp</span><span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Application</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"init fcm"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/java/ch/rasc/swpush/fcm/FcmClient.java#L29-L40" target="_blank">FcmClient.java</a></small></p> 
<p>In this example, we send the messages to a topic that is routed to all clients that are subscribed to this topic. FCM also supports sending messages to specific clients.</p> 
<p>The Firebase SDK provides the <code>sendAsync()</code> method that pushes messages to the clients. It takes a Message instance as a parameter. In the Message object, we specify the topic and specify the time to live in seconds. If FCM cannot deliver the message in that time frame, FCM deletes the message, and the client never receives it. You can specify a TTL of up to 4 weeks. The chance that you reach all connected clients is higher with a longer TTL. But even with a long time to live, it is possible that we don't reach all clients when they don't start their browser during that time.</p> 
<pre><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> data<span class="token punctuation">)</span>
      <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">ExecutionException</span> <span class="token punctuation">{</span>

    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAllData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token string">"chuck"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setWebpushConfig</span><span class="token punctuation">(</span><span class="token class-name">WebpushConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putHeader</span><span class="token punctuation">(</span><span class="token string">"ttl"</span><span class="token punctuation">,</span> <span class="token string">"300"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setNotification</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpushNotification</span><span class="token punctuation">(</span><span class="token string">"Background Title (server)"</span><span class="token punctuation">,</span>
                <span class="token string">"Background Body (server)"</span><span class="token punctuation">,</span> <span class="token string">"mail2.png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span> response <span class="token operator">=</span> <span class="token class-name">FirebaseMessaging</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendAsync</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Sent message: "</span> <span class="token operator">+</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/java/ch/rasc/swpush/fcm/FcmClient.java#L42-L54" target="_blank">FcmClient.java</a></small></p> 
<p>The notification object is optional and provides information that is displayed in the little popup window that appears when the client receives the message while the browser is in the background. We're going to see later that you can configure this information on the client too.</p> 
<p>The <code>data</code> part of the message consists of custom key-value pairs (String-&gt;String). This is the data the client receives and has access to in the push message. Note that the data is limited to 4KB.<br> For more details, see the documentation:<br> <a href="https://firebase.google.com/docs/cloud-messaging/concept-options">https://firebase.google.com/docs/cloud-messaging/concept-options</a></p> 
<h2><a href="https://golb.hplar.ch/2018/01/Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html#client" id="client">Client</a></h2> 
<p>On the client-side, we first create the index.html page. We add a <code>div</code> section where the JavaScript code displays the received messages.<br> We also add a link to the <code>manifest.json</code> file and import the Firebase JavaScript libraries and index.js, that contains our JavaScript application.</p> 
<pre><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span>utf-8</span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Web Push<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>manifest<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>manifest.json<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
     <span class="token selector">body</span> <span class="token punctuation">{</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> -apple-system<span class="token punctuation">,</span> BlinkMacSystemFont<span class="token punctuation">,</span> <span class="token string">"Segoe UI"</span><span class="token punctuation">,</span> Roboto<span class="token punctuation">,</span> Helvetica<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token selector">.header</span> <span class="token punctuation">{</span>
        <span class="token property">font-family</span><span class="token punctuation">:</span> monospace<span class="token punctuation">;</span>
        <span class="token property">font-size</span><span class="token punctuation">:</span> 1.1em<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token selector">.joke</span> <span class="token punctuation">{</span>
        <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
    
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>outTable<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://www.gstatic.com/firebasejs/7.10.0/firebase-messaging.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>index.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/static/index.html" target="_blank">index.html</a></small></p> 
<p>Next, we write the Service Worker (<code>sw.js</code>). First, we need to import the Firebase library.<br> Then the application has to call the <code>initializeApp</code> method with the <code>apiKey</code>, <code>projectId</code>, <code>messageSenderId</code>, and <code>appId</code>. These are the keys we got when we added a Web app to our Firebase project.</p> 
<p>We also configure the public VAPID with <code>messaging.usePublicVapidKey</code>. This is the key we created under the section "Web Push certificates" in the Firebase Console.</p> 
<pre><code class="language-js"><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'https://www.gstatic.com/firebasejs/7.10.0/firebase-app.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">'https://www.gstatic.com/firebasejs/7.10.0/firebase-messaging.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

firebase<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  apiKey<span class="token operator">:</span> <span class="token string">"AIzaSyAMBZJQqEL9ZjA2Y01E0bj9wV4BGZMvdJU"</span><span class="token punctuation">,</span>
  projectId<span class="token operator">:</span> <span class="token string">"demopush-7dacf"</span><span class="token punctuation">,</span>
  messagingSenderId<span class="token operator">:</span> <span class="token string">"425242423819"</span><span class="token punctuation">,</span>
  appId<span class="token operator">:</span> <span class="token string">"1:425242423819:web:e34dad8cf7e765216c8d0e"</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> messaging <span class="token operator">=</span> firebase<span class="token punctuation">.</span><span class="token function">messaging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messaging<span class="token punctuation">.</span><span class="token function">usePublicVapidKey</span><span class="token punctuation">(</span><span class="token string">'BE-ASg0VyvsQIxoCzGF7K7cT5Xzj_eJCsnZytY3q71Mwou_5i7S0-9NTQwfpU8wdmZXRb3w7DXSfoXms0QXeybc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/static/sw.js#L1-L12" target="_blank">sw.js</a></small></p> 
<p>Our Service Worker installs an event listener that listens for the <code>push</code> event. The browser emits this event each time a new push message arrives from FCM, regardless if the application is in the foreground or the tab with the application is closed, or the browser runs in the background.</p> 
<p>The handler reads the key-value pairs from the <code>data</code> section (<code>event.data.json().data</code>) and stores them into an IndexedDB database. IndexedDB is one of the few interfaces that you can access from Service Workers and from foreground scripts. Both have access to the same databases.</p> 
<pre><code class="language-js">self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> tx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token string">'jokes'</span><span class="token punctuation">,</span> <span class="token string">'readwrite'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> tx<span class="token punctuation">.</span><span class="token function">objectStore</span><span class="token punctuation">(</span><span class="token string">'jokes'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  data<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  store<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

  tx<span class="token punctuation">.</span><span class="token function-variable function">oncomplete</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> allClients <span class="token operator">=</span> <span class="token keyword">await</span> clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> includeUncontrolled<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> client <span class="token keyword">of</span> allClients<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'newData'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/static/sw.js#L14-L29" target="_blank">sw.js</a></small></p> 
<p>After the handler stored the message in the database, it sends a message to the foreground script with <code>client.postMessage('newData');</code>.<br> It is possible that the application is open in multiple tabs. Therefore we loop over all clients that are associated with this Service Worker.</p> 
<p>The foreground script (<code>index.js</code>) listens for this message with a <code>message</code> handler.</p> 
<pre><code class="language-js">  navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">'newData'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">showData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/static/index.js#L22-L26" target="_blank">index.js</a></small></p> 
<p><strong>Note</strong>: Both handlers, the <code>push</code> handler in the Service Worker and the <code>message</code> handler in the foreground, are called when a push message arrives while the application is in the foreground. When the application is not open or in the background, only the <code>push</code> handler in the Service Worker is called.<br> The foreground script, in our example, ignores message invocations from the push service and only reacts to the <code>postMessage('newData')</code> call from the Service Worker (<code>if (event.data === 'newData')</code>).</p> 
<br> 
<p>In the foreground script (<code>index.js</code>), we configure Firebase as we do in the Service Worker.</p> 
<pre><code class="language-js">  <span class="token keyword">const</span> registration <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/sw.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">;</span>  
  firebase<span class="token punctuation">.</span><span class="token function">initializeApp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    apiKey<span class="token operator">:</span> <span class="token string">"AIzaSyAMBZJQqEL9ZjA2Y01E0bj9wV4BGZMvdJU"</span><span class="token punctuation">,</span>
    projectId<span class="token operator">:</span> <span class="token string">"demopush-7dacf"</span><span class="token punctuation">,</span>
    messagingSenderId<span class="token operator">:</span> <span class="token string">"425242423819"</span><span class="token punctuation">,</span>
    appId<span class="token operator">:</span> <span class="token string">"1:425242423819:web:e34dad8cf7e765216c8d0e"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> messaging <span class="token operator">=</span> firebase<span class="token punctuation">.</span><span class="token function">messaging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  messaging<span class="token punctuation">.</span><span class="token function">usePublicVapidKey</span><span class="token punctuation">(</span><span class="token string">'BE-ASg0VyvsQIxoCzGF7K7cT5Xzj_eJCsnZytY3q71Mwou_5i7S0-9NTQwfpU8wdmZXRb3w7DXSfoXms0QXeybc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/static/index.js#L3-L12" target="_blank">index.js</a></small></p> 
<p>Then we need to link the Service Worker with the Firebase library (<code>messaging.useServiceWorker</code>).<br> There is an alternative way to do that. Name your Service Worker file <code>firebase-messaging-sw.js</code> and then remove the <code>navigator.serviceWorker.register</code> and <code>messaging.useServiceWorker</code> lines. The Firebase library, in that case, automatically installs the Service Worker for you. This is a more convenient way to set things up. But in this example, I set up everything manually.</p> 
<pre><code class="language-js">  messaging<span class="token punctuation">.</span><span class="token function">useServiceWorker</span><span class="token punctuation">(</span>registration<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> messaging<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Unable to get permission'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/static/index.js#L13-L20" target="_blank">index.js</a></small></p> 
<p>After the setup, we have to request permission from the user. An application can only receive push messages when the user gives his permission. <code>messaging.requestPermission()</code> opens a little dialog that asks for permission. The user sees this dialog only once per domain. If he declines the request, there is no way for an application to ask again.</p> 
<p><img src="./Sending Web push messages from Spring Boot to Browsers_files/web_push13.png" alt="AskPermission"></p> 
<p>When the user gave permission, and the client could connect to FCM, a token is assigned to this client. This is a unique reference for this particular client.<br> You can access this token with the <code>messaging.getToken()</code> method. You should also install a handler for the <code>tokenRefresh</code> event. Firebase could assign a new token while the application is running.</p> 
<pre><code class="language-js">  <span class="token keyword">const</span> currentToken <span class="token operator">=</span> <span class="token keyword">await</span> messaging<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span> body<span class="token operator">:</span> currentToken <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">showData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  messaging<span class="token punctuation">.</span><span class="token function">onTokenRefresh</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'token refreshed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newToken <span class="token operator">=</span> <span class="token keyword">await</span> messaging<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span> body<span class="token operator">:</span> currentToken <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/static/index.js#L28-L36" target="_blank">index.js</a></small></p> 
<p>The sender of push messages, in our example, the Spring Boot application, needs to know this client token so it can subscribe the client to the topic. We send the token to the <code>/register</code> HTTP endpoint with a POST request.</p> 
<p>In the Spring Boot application, we add a Controller for this endpoint.</p> 
<pre><code class="language-java">  <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ResponseStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>NO_CONTENT<span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> token<span class="token punctuation">.</span><span class="token function">doOnNext</span><span class="token punctuation">(</span>t <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fcmClient<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"chuck"</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/java/ch/rasc/swpush/RegistryController.java#L23-L27" target="_blank">RegistryController.java</a></small></p> 
<p>When you address clients directly with the token, you need to store it somewhere and perhaps associate it with a logged-in user.<br> But in this example, we send messages to a topic, so we subscribe the client to the topic <code>chuck</code>.</p> 
<p>We don't have to manage the subscriptions ourselves. Firebase does that for use. We only have to send Firebase the token of the client and the topic name.<br> The Firebase SDK provides the method <code>subscribeToTopicAsync()</code> for this purpose. It takes as first parameter one or more client tokens and as the second parameter, the topic name. FCM then subscribes all provided clients to this topic.</p> 
<pre><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">String</span> clientToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">TopicManagementResponse</span> response <span class="token operator">=</span> <span class="token class-name">FirebaseMessaging</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">subscribeToTopicAsync</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>clientToken<span class="token punctuation">)</span><span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out
          <span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getSuccessCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" tokens were subscribed successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Application</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"subscribe"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/java/ch/rasc/swpush/fcm/FcmClient.java#L56-L66" target="_blank">FcmClient.java</a></small></p> 
<br> 
<p>To test the application, start Spring Boot and then open the application in the browser with the URL <code>http://localhost:8080/index.html</code>. When everything is set up correctly, you should see a new joke appear every 30 seconds.</p> 
<p>Now close the tab or open another tab or minimize the browser window. You should see a little popup dialog when a message arrives.<br> <img src="./Sending Web push messages from Spring Boot to Browsers_files/web_push14.png" alt="NotificationServer"></p> 
<p>You only see this message when the tab with our application is closed or not activated. The browser is only able to receive push messages when he is running. In Desktop Chrome, you can enable the following setting, and it stays in the background when you close the browser.<br> <img src="./Sending Web push messages from Spring Boot to Browsers_files/web_push16.png" alt="BackgroundSetting"></p> 
<h2><a href="https://golb.hplar.ch/2018/01/Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html#notification" id="notification">Notification</a></h2> 
<p>In the sending part, you saw that we also specified a notification object together with the payload of the message</p> 
<pre><code class="language-java">    <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAllData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token string">"chuck"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setWebpushConfig</span><span class="token punctuation">(</span><span class="token class-name">WebpushConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putHeader</span><span class="token punctuation">(</span><span class="token string">"ttl"</span><span class="token punctuation">,</span> <span class="token string">"300"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">setNotification</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebpushNotification</span><span class="token punctuation">(</span><span class="token string">"Background Title (server)"</span><span class="token punctuation">,</span>
                <span class="token string">"Background Body (server)"</span><span class="token punctuation">,</span> <span class="token string">"mail2.png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/java/ch/rasc/swpush/fcm/FcmClient.java#L45-L50" target="_blank">FcmClient.java</a></small></p> 
<p>You see this information in the popup window that the browser displays when the message arrives. As mentioned before, you only see this window when the tab with our application is not active or in the background.</p> 
<p>Instead of sending the notification object from the server, you can configure it in the Service Worker code.<br> For that purpose, you need to install a background message handler. In that handler, you construct a notification object and display the notification with <code>self.registration.showNotification</code></p> 
<pre><code class="language-js">messaging<span class="token punctuation">.</span><span class="token function">setBackgroundMessageHandler</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> notificationTitle <span class="token operator">=</span> <span class="token string">'Background Title (client)'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> notificationOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    body<span class="token operator">:</span> <span class="token string">'Background Body (client)'</span><span class="token punctuation">,</span>
    icon<span class="token operator">:</span> <span class="token string">'/mail.png'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>notificationTitle<span class="token punctuation">,</span>
      notificationOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><small class="gh"><a href="https://github.com/ralscha/blog/blob/master/sw-push/src/main/resources/static/sw.js#L52-L61" target="_blank">sw.js</a></small></p> 
<p>Note that this background handler is <strong>NOT</strong> called when the push message already contains a notification object.<br> If you want to test the client configuration, you need to remove the <code>setNotification()</code> call in the Java code.</p> 
<pre><code class="language-java"> <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token class-name">Message</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAllData</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token string">"chuck"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setWebpushConfig</span><span class="token punctuation">(</span><span class="token class-name">WebpushConfig</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putHeader</span><span class="token punctuation">(</span><span class="token string">"ttl"</span><span class="token punctuation">,</span> <span class="token string">"300"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>When everything is set up correctly, you should see this message<br> <img src="./Sending Web push messages from Spring Boot to Browsers_files/web_push15.png" alt="NotificationClient"></p> 
<br> 
<p>This concludes our journey into Web Push Message country. Thanks to the Firebase JavaScript library, the set up on the client is straightforward because the library does most of the work for us.</p>
  </article>
  
  <footer>
  	<a href="https://golb.hplar.ch/index.html">Home</a> | <a href="https://golb.hplar.ch/feed.rss">RSS</a> | <a href="https://golb.hplar.ch/feed.atom">Atom</a> | <a href="https://golb.hplar.ch/feedback/2018-01-Sending-Web-push-messages-from-Spring-Boot-to-Browsers.html">Send Feedback</a>
  </footer>


</body></html>